<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.library.mapper.mylib.ReadingRoomMapper">
	
	<!-- 모든 자리 정보 출력 -->
	<!-- <select id="getSeatsList" resultType="com.library.model.mylib.ReadingRoomDTO">
		select rr.seat_no as seat_no, seat_status, user_id, reg_time, return_time 
  		  from reading_room1 as rr left join reading_room1_rental as rt
      	 	on rr.seat_no = rt.seat_no 
      	 order by seat_no
      	 limit #{skip}, #{amount}
	</select> -->
	
	<!-- 열람실 출력 -->
	<select id="getReadingRoom1SeatsList" resultType="com.library.model.mylib.ReadingRoomDTO">
		select * 
		  from reading_room 
		 where seat_no &lt; 55
	     order by seat_no
	</select>
	
	<!-- 열람실 예약 좌석 정보 -->
	<select id="mySeatInfo" resultType="com.library.model.mylib.ReadingRoomDTO">
		select * 
		  from reading_room
		 where user_id = #{user_id}
	</select>
	
	<!-- 좌석 예약 -->
	<update id="bookingSeat">
		update reading_room
		   set user_id = #{user_id}, 
		   	   checkin_time = current_timestamp, 
		   	   checkout_time = CASE 
		   	   						WHEN substr(current_timestamp, 12, 2) >= 15 
		   	   						THEN date_add(curdate(), interval 18 hour)
		   	   						ELSE date_add(current_timestamp, interval 3 hour)
		   	   				   END
		 where seat_no = #{seat_no}
	</update>
	
	<!-- 좌석 반납 -->
	<delete id="returnSeat">
		update reading_room
		   set user_id = null, checkin_time = null, checkout_time = null
		 where user_id = #{user_id}
	</delete>
		
	<!-- 좌석 연장 -->
	<update id="extendSeat">
		update reading_room
		   set checkout_time = CASE 
		   	   						WHEN substr(current_timestamp, 12, 2) >= 16 
		   	   						THEN date_add(curdate(), interval 18 hour)
		   	   						ELSE date_add(current_timestamp, interval 2 hour)
		   	   				   END
		 where user_id = #{user_id}
	</update>

	<!-- 좌석 상태 확인 -->
	<select id="seat_check" resultType="int">
		select count(*)
		  from reading_room
		 where seat_no = #{seat_no} and user_id is null
	</select>






	<!-- 사용 가능 좌석 -->
	<select id="rdUsingSeat" resultType="int">
		select count(*) - (select count(*) from reading_room1 where seat_status = 0)
		  from reading_room1
	</select>
	 
	 
	<!-- 사용 중인 좌석 -->
	<select id="rdUsedSeat" resultType="int">
		select count(*) from reading_room1 where seat_status = 0
	</select>
		
		
		
	
	<!-- 열람실 좌석 insert -->
	<select id="insert">
		insert into reading_room values(#{seat_no}, null, null, null)
	</select>
	
</mapper>
